#include "board.h"
#include "input.h"
#include "game.h"
#include "menu.h"
#include "ai.h"
#include <stdio.h>
#include "stats.h"

void game_init_pvp(void) {
	int running = 1;
	count_game_pvp();
	int count_moves = 0;
	int turn = 0; // 0 = player 1, 1 = player 2
	int winner = 0;
	GameMove move;
	Cell player;
	while (running) {
		if (count_moves == 42) {
			print_centered("It's a Draw!");
			running = press_enter_to_proceed();
			clear_console();
			break;
		}
		if (turn == 0) {
			print_centered("Player 1's turn (Red)");
			player = cell_player1;
			turn = 1;
		} else {
			print_centered("Player 2's turn (Yellow)");
			player = cell_player2;
			turn = 0;
		}
		// get player's move
		move = input_player_move();
		board[move.row][move.column] = player;
		clear_console();
		board_print();
		count_moves++;
		if (count_moves > 6) {
			winner = check_winner(move, player);
			if(winner == 1){
				if (player == cell_player1) {
					print_centered("Player 1 (Red) wins!");
					player_1_win_pvp();
				} else {
					print_centered("Player 2 (Yellow) wins!");
					player_2_win_pvp();
				}
				running = press_enter_to_proceed();
				clear_console();
				break;
			}
		}
	}
}

void game_init_easy() {
	int running = 1;
	count_game_easy();
	int count_moves = 0;
	int turn = 0; // 0 = player, 1 = computer
	int winner = 0;
	Cell player;
	GameMove move;
	while (running) {
		if (count_moves == 42) {
			print_centered("It's a Draw!");
			running = press_enter_to_proceed();
			clear_console();
			break;
		}
		if (turn == 0) {
			print_centered("Player 1's turn (Red)");
			player = cell_player1;
			move = input_player_move();
			turn = 1;
		}
		else {
			print_centered("Computer is thinking...");
			player = cell_player2;
			move = ai_easy_move();
			turn = 0;
		}
		board[move.row][move.column] = player;
		clear_console();
		board_print();
		count_moves++;
		if (count_moves > 6) {
			winner = check_winner(move, player);
			if (winner == 1) {
				if (player == cell_player1) {
					print_centered("Player (Red) wins!");
					player_1_win_easy(); // Track player win
				}
				else {
					print_centered("Computer Won! Better luck next time!");
					pc_win_easy(); // Track computer win
				}
				running = press_enter_to_proceed();
				clear_console();
				break;
			}
		}
	}
}

void game_init_medium() {
	int running = 1;
	count_game_medium(); // ADD THIS - Count the game at start
	int count_moves = 0;	
	int turn = 0; // 0 = player, 1 = computer
	int winner = 0;
	Cell player;
	GameMove move;
	while (running) {
		if (count_moves == 42) {
			print_centered("It's a Draw!");
			running = press_enter_to_proceed();
			clear_console();
			break;
		}
		if (turn == 0) {
			print_centered("Player 1's turn (Red)");
			player = cell_player1;
			move = input_player_move();
			turn = 1;
		}
		else {
			print_centered("Computer is thinking...");
			player = cell_player2;
			move = ai_medium_move();
			turn = 0;
		}
		board[move.row][move.column] = player;
		clear_console();
		board_print();
		count_moves++;
		if (count_moves > 6) {
			winner = check_winner(move, player);
			if (winner == 1) {
				if (player == cell_player1) {
					print_centered("Player 1 (Red) wins!");
					player_1_win_medium(); // ADD THIS - Track player win
				}
				else {
					print_centered("Computer Won! Better luck next time!");
					pc_win_medium(); // ADD THIS - Track computer win
				}
				running = press_enter_to_proceed();
				clear_console();
				break;
			}
		}
	}
}

int check_vertical(GameMove last_move, Cell player) {
	int temp_row, temp_col;
	temp_col = last_move.column;
	temp_row = last_move.row;
	int count = 1;
	// check upwards
	while (temp_row + 1 < ROWS && board[temp_row + 1][temp_col] == player && count<4) {
		count++;
		temp_row++;
	}
	if (count == 4) {
		return 1;
	}
	else {
		count = 1;
		// check downwards
		while (temp_row - 1 >= 0 && board[temp_row - 1][temp_col] == player && count<4) {
			count++;
			temp_row--;
		}
	}
	if (count == 4) {
		return 1;
	} else {
		return 0;
	}
}

int check_horizontal(GameMove last_move, Cell player) {
	int temp_row, temp_col;
	temp_col = last_move.column;
	temp_row = last_move.row;
	int count = 1;
	// check right
	while (temp_col + 1 < COLS && board[temp_row][temp_col + 1] == player && count < 4) {
		count++;
		temp_col++;
	}
	if (count == 4) {
		return 1;
	}
	else {
		count = 1;
		// check left
		while (temp_col - 1 >= 0 && board[temp_row][temp_col - 1] == player && count < 4) {
			count++;
			temp_col--;
		}
		if (count == 4) {
			return 1;
		}
		else {
			return 0;
		}
	}
}

int check_diagonal(GameMove last_move, Cell player) {
	int temp_row, temp_col;
	temp_col = last_move.column;
	temp_row = last_move.row;
	int count = 1;
	// check top-right
	while (temp_row + 1 < ROWS && temp_col + 1 < COLS && board[temp_row + 1][temp_col + 1] == player && count < 4) {
		count++;
		temp_row++;
		temp_col++;
	}
	if (count == 4) {
		return 1;
	}else{
		count = 1;
		// check bottom-left
		while (temp_row - 1 >= 0 && temp_col - 1 >= 0 && board[temp_row - 1][temp_col - 1] == player && count < 4) {
			count++;
			temp_row--;
			temp_col--;
		}
	}
	if(count == 4){
		return 1;
	}
	else {
		count = 1;
		// check top-left
		while (temp_row + 1 < ROWS && temp_col - 1 >= 0 && board[temp_row + 1][temp_col - 1] == player && count < 4) {
			count++;
			temp_row++;
			temp_col--;
		}
	}
	if (count == 4){
		return 1;
	}
	else {
		count = 1;
		// check bottom-right
		while (temp_row - 1 >= 0 && temp_col + 1 < COLS && board[temp_row - 1][temp_col + 1] == player && count < 4) {
			count++;
			temp_row--;
			temp_col++;
		}
	}
	if (count == 4) {
		return 1;
	}
return 0;
}


int check_winner(GameMove last_move, Cell player) {
	int result = 0;
	// Check vertical
	result = check_vertical(last_move, player);
	if(result == 1) {
		return 1;
	}
	result = check_horizontal(last_move, player);
	if (result == 1) {
		return 1;
	}
	result = check_diagonal(last_move, player);
	if (result == 1) {
		return 1;
	}
	return 0;
}