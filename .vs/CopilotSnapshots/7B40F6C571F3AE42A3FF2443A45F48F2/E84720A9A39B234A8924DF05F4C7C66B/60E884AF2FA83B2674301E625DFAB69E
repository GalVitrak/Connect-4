#include <stdio.h>
#include <stdlib.h>
#include "board.h"

#ifdef _WIN32
#include <windows.h>
#endif

#define ROWS 6
#define COLS 7

// initialize the board to be empty
void board_init(void) {
    for (int r = 0; r < ROWS; r++) {
        for (int c = 0; c < COLS; c++) {
            board[r][c] = cell_empty;
        }
    }
}

#ifdef _WIN32
static void enable_ansi_colors_once(void)
{
    static int tried = 0;
    if (tried) return;
    tried = 1;

    HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
    if (hOut == INVALID_HANDLE_VALUE) return;

    DWORD mode = 0;
    if (!GetConsoleMode(hOut, &mode)) return;

    // Enable virtual terminal processing so ANSI escape codes work on Windows consoles
    mode |= ENABLE_VIRTUAL_TERMINAL_PROCESSING;
    SetConsoleMode(hOut, mode);
}
#else
static void enable_ansi_colors_once(void) { /* no-op on POSIX */ }
#endif

static int get_console_width(void) {
#ifdef _WIN32
	CONSOLE_SCREEN_BUFFER_INFO csbi;
	int width = 80;
	
	if (GetConsoleScreenBufferInfo(GetStdHandle(STD_OUTPUT_HANDLE), &csbi)) {
		width = csbi.srWindow.Right - csbi.srWindow.Left + 1;
	}
	return width;
#else
	return 80;
#endif
}

// Print the board using simple ASCII borders and optional ANSI colors for pieces.
void board_print(void) {
    enable_ansi_colors_once();

    const char* col_red = "\x1b[31m";    // red
    const char* col_yellow = "\x1b[33m"; // yellow
    const char* col_gray = "\x1b[90m";   // light gray
    const char* col_reset = "\x1b[0m";   // reset

    // Calculate board width (approximately 32 characters wide)
    int board_width = 32;
    int console_width = get_console_width();
    int left_padding = (console_width - board_width) / 2;

    // Column headers (1-based)
    for (int i = 0; i < left_padding; i++) printf(" ");
    printf("   ");
    for (int c = 0; c < COLS; ++c) {
        printf("  %d ", c + 1);
    }
    printf("\n");

    // Top border
    for (int i = 0; i < left_padding; i++) printf(" ");
    printf("   +");
    for (int c = 0; c < COLS; ++c) printf("---+");
    printf("\n");

    for (int r = 0; r < ROWS; ++r) {
        // display rows as 1-based
        for (int i = 0; i < left_padding; i++) printf(" ");
        printf("%2d |", r + 1);
        for (int c = 0; c < COLS; ++c) {
            Cell v = board[r][c];
            if (v == cell_player1) {
                printf(" %sX%s |", col_red, col_reset);
            } else if (v == cell_player2) {
                printf(" %sO%s |", col_yellow, col_reset);
            } else {
                printf(" %s.%s |", col_gray, col_reset);
            }
        }
        printf("\n");

        // Row separator
        for (int i = 0; i < left_padding; i++) printf(" ");
        printf("   +");
        for (int c = 0; c < COLS; ++c) printf("---+");
        printf("\n");
    }
}