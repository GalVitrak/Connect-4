/**
 * Connect-4 Game - Input Module Implementation
 * Handles all user input with validation and error handling
 */

#include <stdio.h>
#include <string.h>
#include "board.h"
#include "input.h"
#include "menu.h"

/**
 * Get integer input within specified range
 * Handles invalid input and out-of-range values
 */
int input_player_int_range(int low, int high) {
	char prompt[100];
	snprintf(prompt, sizeof(prompt), "Please select an option (%d-%d): ", low, high);
	
	// Get padding for centering
	int console_width = get_console_width();
	int prompt_len = strlen(prompt);
	int padding = (console_width - prompt_len - 5) / 2; // -5 for input space
	
	// Print padding
	if (padding > 0) {
		for (int i = 0; i < padding; i++) {
			printf(" ");
		}
	}
	printf("%s", prompt);
	
	int value;
	while (1) {
		int result = scanf("%d", &value);
		if (result != 1) {
			// Invalid input, clear stdin
			int c;
			while ((c = getchar()) != '\n' && c != EOF);
			
			// Print centered error message
			print_centered("Invalid input.");
			if (padding > 0) {
				for (int i = 0; i < padding; i++) {
					printf(" ");
				}
			}
			printf("Please enter a number (%d-%d): ", low, high);
			continue;
		}
		if (value < low || value > high) {
			// Print centered error message
			print_centered("Input out of range.");
			if (padding > 0) {
				for (int i = 0; i < padding; i++) {
					printf(" ");
				}
			}
			printf("Please enter a number (%d-%d): ", low, high);
			continue;
		}
		// Valid input
		break;
	}
	printf("\n");
	return value;
}

/**
 * Get player's column choice and validate
 * Returns the move with calculated row position based on gravity
 */
GameMove input_player_move(void) {
	int column = input_player_int_range(1, 7) - 1;
	// Check if column is full
	int i;
	int full = 1;
	int row;
	for (i = ROWS - 1; i >= 0; i--) {
		if (board[i][column] == cell_empty) {
			full = 0;
			row = i;
			break;
		}
	}
	if (full) {
		print_centered("Column full, please choose another column");
		return input_player_move();
	} else {
		GameMove move = { row, column };
		return move;
	}
}

/**
 * Wait for user to press Enter before proceeding
 * Returns 0 to signal game loop exit
 */
int press_enter_to_proceed(void) {
	// Clear any remaining input in buffer
	int c;
	while ((c = getchar()) != '\n' && c != EOF);

	print_centered("Press Enter to return to main menu...");
	getchar(); // Wait for Enter key

	return 0; // Return 0 to exit game loop
}